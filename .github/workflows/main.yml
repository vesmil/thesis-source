name: CI

on: [push, pull_request]

jobs:
  format:
    runs-on: ubuntu-latest
    container:
      image: ubuntu:latest

    steps:
    - name: Checkout
      uses: actions/checkout@v2

    - name: Install dependencies
      run: |
        apt-get update && apt-get install -y clang-format git

    - name: Format
      run: clang-format -i src/*.cpp include/*.h

    - name: Check for changes
      run: git diff --exit-code

  build:
    needs: format
    runs-on: ubuntu-latest
    container:
      image: ubuntu:latest

    steps:
    - name: Checkout
      uses: actions/checkout@v2

    - name: Install dependencies
      run: |
        apt-get update && apt-get install -y clang cmake libfuse-dev libgtest-dev libsodium-dev pkg-config libboost-program-options-dev

    - name: Build
      run: |
        mkdir build && cd build
        cmake ../ && make

    - name: Upload artifacts
      uses: actions/upload-artifact@v2
      with:
        name: build
        path: build/
        retention-days: 7

  test:
    needs: build
    runs-on: ubuntu-latest
    container:
      image: ubuntu:latest

    steps:
    - name: Checkout
      uses: actions/checkout@v2

    - name: Download artifacts
      uses: actions/download-artifact@v2
      with:
        name: build
        path: build/

    - name: Install dependencies
      run: |
        apt-get update && apt-get install -y libfuse-dev libgtest-dev libsodium-dev libboost-program-options-dev

    - name: Test
      run: |
        cd build
        ./customvfs --mountpoint /tmp/customvfs
        ./customvfs_tests --mountpoint /tmp/customvfs

